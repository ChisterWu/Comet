stages:
- stage: BuildSource
  jobs:
  - job: BuildSystem.MauiBlazor
    displayName: Build System.Maui Blazor
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - task: UseDotNet@2
        displayName: 'Use .NET Core sdk'
        inputs:
          packageType: sdk
          version: 3.0.100-preview9-014004
          includePreviewVersions: true
          installationPath: $(Agent.ToolsDirectory)/dotnet
      - task: DotNetCoreCLI@2
        displayName: 'Build Blazor'
        inputs:
          command: 'build'
          projects: 'System.Maui.Blazor.sln'
          arguments: '-c $(BuildConfiguration)'
      - task: DotNetCoreCLI@2
        displayName: 'Test Blazor'
        inputs:
          command: 'test'
          projects: 'System.Maui.Blazor.sln'
          arguments: '-c $(BuildConfiguration)'
      - task: DotNetCoreCLI@2
        displayName: 'Pack Blazor'
        inputs:
          command: 'pack'
          packagesToPack: 'src/System.Maui.Blazor/System.Maui.Blazor.csproj'
          arguments: '-c $(BuildConfiguration)'
      - task: PublishBuildArtifacts@1
        inputs:
          pathtoPublish: '$(Build.ArtifactStagingDirectory)'
          artifactName: drop

  - job: BuildSystem.MauiMac
    displayName: Build System.Maui Mac
    pool:
      name: Hosted macOS
      vmImage: 'macOS-latest'
      demands:
      - MSBuild
      - Xamarin.Android
      - xcode
      - Xamarin.iOS
      - msbuild

    steps:
    - task: NuGetToolInstaller@1
      displayName: Use Nuget 5.0.2
      inputs:
        versionSpec: '5.0.2'

    - task: NuGetCommand@2
      displayName: 'NuGet restore'
      inputs:
        restoreSolution: build/System.Maui-Mac.sln

    - task: MSBuild@1
      displayName: 'Build System.Maui'
      inputs:
        solution: 'src/System.Maui/System.Maui.csproj'
        configuration: '$(BuildConfiguration)'

    - task: MSBuild@1
      displayName: 'Build Xamarin.Forms.Loader.csproj'
      inputs:
        solution: 'src/Xamarin.Forms.Loader/Xamarin.Forms.Loader.csproj'
        configuration: '$(BuildConfiguration)'

    - task: MSBuild@1
      displayName: 'Build System.Maui.Android'
      inputs:
        solution: 'src/System.Maui.Android/System.Maui.Android.csproj'
        configuration: '$(BuildConfiguration)'

    - task: MSBuild@1
      displayName: 'Build System.Maui.iOS'
      inputs:
        solution: 'src/System.Maui.iOS/System.Maui.iOS.csproj'
        configuration: '$(BuildConfiguration)'

    - task: MSBuild@1
      displayName: 'Build System.Maui.Mac'
      inputs:
        solution: 'src/System.Maui.Mac/System.Maui.Mac.csproj'
        configuration: '$(BuildConfiguration)'

    - task: MSBuild@1
      displayName: 'Build System.Maui.Skia'
      inputs:
        solution: 'src/System.Maui.Skia/System.Maui.Skia.csproj'
        configuration: '$(BuildConfiguration)'
    
    - task: MSBuild@1
      displayName: 'Build System.Maui.Skia.Android'
      inputs:
        solution: 'src/System.Maui.Skia.Android/System.Maui.Skia.Android.csproj'
        configuration: '$(BuildConfiguration)'

    - task: MSBuild@1
      displayName: 'Build System.Maui.Skia.iOS'
      inputs:
        solution: 'src/System.Maui.Skia.iOS/System.Maui.Skia.iOS.csproj'
        configuration: '$(BuildConfiguration)'

    - task: MSBuild@1
      displayName: 'Build System.Maui.Skia.Mac'
      inputs:
        solution: 'src/System.Maui.Skia.Mac/System.Maui.Skia.Mac.csproj'
        configuration: '$(BuildConfiguration)'

  - job: BuildSystem.MauiWindows
    displayName: Build System.Maui Windows
    pool:
      vmImage: 'windows-2019'
      demands:
      - MSBuild
    
    steps:
    - task: NuGetToolInstaller@1
      displayName: Use Nuget 5.0.2
      inputs:
        versionSpec: '5.0.2'

    - task: NuGetCommand@2
      displayName: 'NuGet restore'
      inputs:
        restoreSolution: build/System.Maui-Windows.sln

    - task: MSBuild@1
      displayName: 'Build System.Maui.UWP'
      inputs:
        solution: 'src/System.Maui.UWP/System.Maui.UWP.csproj'
        configuration: '$(BuildConfiguration)'

    - task: MSBuild@1
      displayName: 'Build System.Maui.WPF'
      inputs:
        solution: 'src/System.Maui.WPF/System.Maui.WPF.csproj'
        configuration: '$(BuildConfiguration)'

    - task: MSBuild@1
      displayName: 'Build System.Maui.Skia.UWP'
      inputs:
        solution: 'src/System.Maui.Skia.UWP/System.Maui.Skia.UWP.csproj'
        configuration: '$(BuildConfiguration)'

    - task: MSBuild@1
      displayName: 'Build System.Maui.Skia.WPF'
      inputs:
        solution: 'src/System.Maui.Skia.WPF/System.Maui.Skia.WPF.csproj'
        configuration: '$(BuildConfiguration)'

- stage: RunTests
  jobs:
  - job: RunSystem.MauiTests
    displayName: Run System.Maui Tests
    pool:
      vmImage: 'windows-2019'
      demands:
      - MSBuild
      - vstest

    steps:
    - task: NuGetToolInstaller@1
      displayName: Use Nuget 5.0.2
      inputs:
        versionSpec: '5.0.2'

    - task: NuGetCommand@2
      displayName: 'NuGet restore'
      inputs:
        restoreSolution: build/System.Maui-Tests.sln

    - task: MSBuild@1
      displayName: 'Build Tests'
      inputs:
        solution: 'tests/System.Maui.Tests/System.Maui.Tests.csproj'
        configuration: '$(BuildConfiguration)'

    - task: VSTest@2
      inputs:
        testSelector: 'testAssemblies'
        testAssemblyVer2: |
          **\bin\$(BuildConfiguration)\netcoreapp2.1\System.Maui.Tests.dll
          !**\obj\**
          !**\xunit.runner.visualstudio.testadapter.dll
          !**\xunit.runner.visualstudio.dotnetcore.testadapter.dll
        searchFolder: '$(System.DefaultWorkingDirectory)'
        codeCoverageEnabled: true
        otherConsoleOptions: '/InIsolation'

- stage: BuildSamples
  jobs:
  - job: BuildSamplesAndroid
    displayName: Build System.Maui Android Samples
    pool:
      name: Hosted macOS
      vmImage: 'macOS-latest'
      demands:
      - MSBuild
      - Xamarin.Android

    steps:
    - script: sudo $AGENT_HOMEDIRECTORY/scripts/select-xamarin-sdk.sh 5_18_1
      displayName: 'Select the Xamarin SDK version'

    - task: NuGetToolInstaller@1
      displayName: Use Nuget 5.0.2
      inputs:
        versionSpec: '5.0.2'

    - task: NuGetCommand@2
      displayName: 'NuGet restore'
      inputs:
        restoreSolution: build/System.Maui-Mac.sln

    - task: XamarinAndroid@1
      displayName: 'Build System.Maui.Android.Sample App'
      inputs:
        projectFile: sample/System.Maui.Android.Sample/System.Maui.Android.Sample.csproj
        configuration: '$(BuildConfiguration)'
        createAppPackage: false

    # - task: XamarinAndroid@1
    #   displayName: 'Build System.Maui.Forms.Android.Sample App'
    #   inputs:
    #     projectFile: sample/Forms/System.Maui.Forms.Sample.Android/System.Maui.Forms.Sample.Android.csproj
    #     configuration: '$(BuildConfiguration)'
    #     createAppPackage: false

  - job: BuildSystem.MauiSamplesiOSMac
    displayName: Build System.Maui iOS and Mac Samples
    pool:
      name: Hosted macOS
      vmImage: 'macOS-latest'
      demands:
      - xcode
      - Xamarin.iOS
      - msbuild

    steps:
    - script: sudo $AGENT_HOMEDIRECTORY/scripts/select-xamarin-sdk.sh 5_18_1
      displayName: 'Select the Xamarin SDK version'

    - task: NuGetToolInstaller@1
      displayName: Use Nuget 5.0.2
      inputs:
        versionSpec: '5.0.2'

    - task: NuGetCommand@2
      displayName: 'NuGet restore'
      inputs:
        restoreSolution: build/System.Maui-Mac.sln

    - task: MSBuild@1
      displayName: 'Build iOS and iOS.Forms'
      inputs:
        solution: 'build/System.Maui-Mac.sln'
        platform: iPhoneSimulator
        configuration: '$(BuildConfiguration)'

    - task: MSBuild@1
      displayName: 'Build Mac'
      inputs:
        solution: 'sample/System.Maui.Mac.Sample/System.Maui.Mac.Sample.csproj'
        configuration: '$(BuildConfiguration)'

  - job: BuildSystem.MauiSamplesWindows
    displayName: Build System.Maui UWP and WPF Samples
    pool:
      vmImage: 'windows-2019'
      demands:
      - MSBuild
    steps:
    - task: NuGetToolInstaller@1
      displayName: Use Nuget 5.0.2
      inputs:
        versionSpec: '5.0.2'

    - task: NuGetCommand@2
      displayName: 'NuGet restore'
      inputs:
        restoreSolution: build/System.Maui-Windows.sln
    
    - task: MSBuild@1
      displayName: 'Build UWP Sample'
      inputs:
        solution: 'sample/System.Maui.UWP.Sample/System.Maui.UWP.Sample.csproj'
        configuration: '$(BuildConfiguration)'
        msbuildArguments: '/p:AppxPackageSigningEnabled=false'

    - task: MSBuild@1
      displayName: 'Build WPF Sample'
      inputs:
        solution: 'sample/System.Maui.WPF.Sample/System.Maui.WPF.Sample.csproj'
        configuration: '$(BuildConfiguration)'
        msbuildArguments: '/p:AppxPackageSigningEnabled=false'